<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
      @page { size: A4; margin: 0; }

      body {
        font-family: 'Roboto', sans-serif;
        font-size: 11px;
        color: #000;
        margin: 0; padding: 0;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .page-background {
        position: fixed;
        top: 0; left: 0;
        width: 210mm; height: 297mm;
        z-index: -1000;
      }
      .page-background img { width: 100%; height: 100%; }

      /* ESTRUCTURA MAESTRA */
      .main-layout-table { width: 100%; border-collapse: collapse; border: none; }
      .content-padding { padding-left: 40px; padding-right: 40px; }
      .logo-spacer { height: 140px; display: block; }
      .footer-spacer { height: 100px; }

      /* ENCABEZADO PACIENTE (Repetitivo) */
      .header-box { 
        background-color: transparent; 
        padding: 5px 0px; 
        margin-bottom: 20px; 
        border-bottom: 2px solid #000; 
      }
      .header-table { width: 100%; border-collapse: collapse; border: none; }
      .header-table td { padding: 2px 0; vertical-align: top; font-size: 11px; border: none; color: #000; }

      .label { font-weight: 700; color: #000; margin-right: 5px; }
      .value { font-weight: 400; color: #000; }

      /* RESULTADOS */
      .family-section { margin-bottom: 20px; page-break-inside: avoid; }
      .family-title { 
        font-size: 12px; font-weight: 700; text-transform: uppercase; 
        margin-bottom: 4px; color: #000;
        border-bottom: 2px solid #000; padding-bottom: 2px;
        display: inline-block; width: 100%;
      }
      .results-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 2px; }
      .results-table th { 
        text-align: left; padding: 6px; font-weight: 700; text-transform: uppercase;
        font-size: 10px; border: none;
        background-color: <?= style.headerBgColor ?>; color: <?= style.headerTxtColor ?>;
      }
      .results-table td { padding: 5px 6px; border-bottom: 1px solid #e0e0e0; vertical-align: middle; }
      .results-table tr:last-child td { border-bottom: none; }
      .text-center { text-align: center; }
      .text-right { text-align: right; }
      .res-bold { font-weight: 700; }

      /* --- ESTILOS DE LA FIRMA --- */
      .signature-section {
        margin-top: 40px;       /* Separaci√≥n de los resultados */
        margin-bottom: 20px;
        text-align: center;     /* Centrar todo */
        page-break-inside: avoid; /* Evitar que se corte la firma en dos hojas */
      }
      .signature-img {
        max-height: 80px;       /* Altura m√°xima de la firma para que no sea gigante */
        max-width: 200px;
        display: block;
        margin: 0 auto;         /* Centrar imagen */
      }
      .signature-line {
        border-top: 1px solid #000;
        width: 200px;
        margin: 5px auto;       /* Centrar l√≠nea */
      }
      .doctor-name {
        font-weight: 700;
        font-size: 11px;
        text-transform: uppercase;
      }
      .doctor-title {
        font-size: 10px;
        color: #444;
      }

      /* BOT√ìN IMPRIMIR */
      .no-print { 
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        background: rgba(255,255,255,0.9); padding: 10px;
        border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2);
        font-family: sans-serif;
      }
      button { padding: 8px 16px; background: #003366; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
      @media print { .no-print { display: none; } }
    </style>
  </head>
  <body>

    <div class="no-print">
      <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
    </div>

    <div class="page-background">
      <img src="<?= style.imgUrl ?>" alt="Membrete">
    </div>

    <table class="main-layout-table">
      
      <!-- ENCABEZADO REPETITIVO -->
      <thead>
        <tr>
          <td class="content-padding">
            <div class="logo-spacer"></div>
            <? var p = data.paciente; ?>
            <? var f = data.factura; ?>
            <div class="header-box">
              <table class="header-table">
                <tr>
                  <td width="40%"><span class="label">Nombre:</span><span class="value"><?= p['name-px'] ?> <?= p['lastname-px'] ?></span></td>
                  <td width="30%"><span class="label">Edad:</span><span class="value"><?= p['old-px'] ?></span>&nbsp;&nbsp;&nbsp;<span class="label">Sexo:</span><span class="value"><?= p['gender-px'] ?></span></td>
                  <td width="30%"><span class="label">No. de Orden:</span><span class="value"><?= f['id-service'] ?></span></td>
                </tr>
                <tr>
                  <td><span class="label">Identificador:</span><span class="value"><?= p['dni-px'] ?></span></td>
                  <td><span class="label">Telf:</span><span class="value"><?= p['phone-px'] ?></span></td>
                  <td><span class="label">F. Muestra:</span><span class="value"><?= f['date-muest-fact'] ?></span></td>
                </tr>
                <tr>
                  <td><span class="label">Procedencia:</span><span class="value"><?= p['address-px'] ?></span></td>
                  <td><span class="label">M√©dico:</span><span class="value"><?= f['doctor-fact'] ?></span></td>
                  <td><span class="label">F. Resultado:</span><span class="value"><?= data.fechaResultado || data.fechaImpresion ?></span></td>
                </tr>
              </table>
            </div>
          </td>
        </tr>
      </thead>

      <!-- CUERPO DE RESULTADOS -->
      <tbody>
        <tr>
          <td class="content-padding">
            <? for (var i = 0; i < data.cuerpo.length; i++) { ?>
              <? var grupo = data.cuerpo[i]; ?>
              <div class="family-section">
                <? if (grupo.info['show-title'] == 'TRUE' || grupo.info['show-title'] === true || grupo.info['show-title'] == "") { ?>
                  <div class="family-title"><?= grupo.info['description-family'] ?></div>
                <? } ?>
                <table class="results-table">
                  <thead>
                    <tr>
                      <th width="35%"><?= grupo.info['header-family-01'] || "PRUEBA" ?></th>
                      <th width="20%" class="text-center"><?= grupo.info['header-family-02'] || "RESULTADO" ?></th>
                      <th width="15%" class="text-center"><?= grupo.info['header-family-03'] || "UNIDADES" ?></th>
                      <th width="30%" class="text-right"><?= grupo.info['header-family-04'] || "VALOR DE REFERENCIA" ?></th>
                    </tr>
                  </thead>
                  <tbody>
                    <? for (var j = 0; j < grupo.resultados.length; j++) { ?>
                      <? var res = grupo.resultados[j]; ?>
                      <tr>
                        <td><?= res.nombre ?></td>
                        <td class="text-center res-bold"><?= res.resultado ?></td>
                        <td class="text-center" style="color:#666; font-size:10px;"><?= res.unidad ?></td>
                        <td class="text-right" style="font-style:italic; color:#444;"><?= res.referencia ?></td>
                      </tr>
                    <? } ?>
                  </tbody>
                </table>
              </div>
            <? } ?>

            <!-- BLOQUE DE FIRMA -->
            <!-- Solo se muestra si se envi√≥ una URL de firma -->
            <? if (style.signUrl && style.signUrl != "") { ?>
              <div class="signature-section">
                <!-- Imagen de la firma -->
                <img src="<?= style.signUrl ?>" class="signature-img" alt="Firma">
                
                <!-- L√≠nea divisoria -->
                <div class="signature-line"></div>
                
                <!-- Nombre del M√©dico (Tomado de la base de datos) -->
                <div class="doctor-name"><?= f['signature-fact'] || "Bioanalista / Validador" ?></div>
                <div class="doctor-title">Lic. en Bioan√°lisis</div>
              </div>
            <? } ?>
            
            <div style="margin-top: 30px; text-align: center; color: #777; font-size: 10px;">
              Documento generado electr√≥nicamente.
            </div>
          </td>
        </tr>
      </tbody>

      <!-- PIE DE P√ÅGINA -->
      <tfoot>
        <tr>
          <td><div class="footer-spacer"></div></td>
        </tr>
      </tfoot>
    </table>
  </body>
</html>
